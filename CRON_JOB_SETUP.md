# Настройка автоматического обновления статусов доставки через cron-job.org

## Почему cron-job.org?

- ✅ Бесплатно
- ✅ Надежно
- ✅ Не требует лимитов Vercel
- ✅ Простая настройка за 5 минут

## Шаг 1: Создайте аккаунт на cron-job.org

1. Перейдите на https://cron-job.org
2. Нажмите "Sign up" (Регистрация)
3. Подтвердите email

## Шаг 2: Создайте Cron Job

1. После входа нажмите **"Create cronjob"**
2. Заполните форму:

### Основные настройки:

**Title (Название):**
```
Update Nova Poshta Delivery Statuses
```

**URL:**
```
https://ваш-домен.vercel.app/api/update-delivery-statuses
```
*(Замените `ваш-домен.vercel.app` на ваш реальный домен)*

**Schedule (Расписание):**
- Выберите: **Every day** (Каждый день)
- Время: **08:00** (или любое удобное время)
- Timezone: **Europe/Kiev** (UTC+2/+3)

### Дополнительные настройки:

**Request method:**
- Выберите: **POST**

**Headers (Заголовки):**
Нажмите "Add header" и добавьте:
```
Authorization: Bearer your-secret-key
```
*(Замените `your-secret-key` на значение из вашего `.env.local` файла - переменная `CRON_SECRET`)*

**Notifications (Уведомления):**
- ✅ Enable notifications on failure (Уведомлять при ошибках)
- Email: ваш email

## Шаг 3: Проверьте настройки в .env.local

Убедитесь, что у вас есть эти переменные:

```env
CRON_SECRET=your-secret-key-here
NOVA_POSHTA_API_KEY=ваш-ключ-новой-почты
SUPABASE_SERVICE_ROLE_KEY=ваш-service-role-ключ
```

## Шаг 4: Сохраните и протестируйте

1. Нажмите **"Create cronjob"**
2. В списке задач найдите созданный Cron Job
3. Нажмите **"Run now"** (Запустить сейчас) для тестирования
4. Проверьте результат в разделе "Execution history"

## Как это работает

1. **cron-job.org** каждый день в 08:00 отправляет POST запрос на ваш API
2. Ваш API проверяет все заказы со статусом "shipped"
3. Для каждого заказа проверяется статус через API Новой Почты
4. Если посылка доставлена - статус автоматически обновляется на "delivered"

## Безопасность

- API защищен секретным ключом (`CRON_SECRET`)
- Только запросы с правильным заголовком `Authorization` будут обработаны
- Никто не сможет вызвать API без знания секретного ключа

## Альтернативные расписания

Если хотите проверять чаще:

- **Каждые 6 часов:** `0 */6 * * *` (00:00, 06:00, 12:00, 18:00)
- **Каждые 12 часов:** `0 */12 * * *` (00:00, 12:00)
- **Два раза в день:** `0 8,20 * * *` (08:00, 20:00)

## Мониторинг

В панели cron-job.org вы можете:
- Видеть историю выполнений
- Получать уведомления об ошибках
- Временно отключать задачу
- Изменять расписание

## Стоимость

- **Бесплатный план:** до 50 Cron Jobs, минимальный интервал 1 минута
- Для вашего случая (1 задача раз в день) - полностью бесплатно

## Troubleshooting

### Ошибка 401 Unauthorized
- Проверьте, что `CRON_SECRET` в `.env.local` совпадает с заголовком в cron-job.org
- Убедитесь, что заголовок указан как `Authorization: Bearer your-secret-key`

### Ошибка 500
- Проверьте логи Vercel
- Убедитесь, что `NOVA_POSHTA_API_KEY` и `SUPABASE_SERVICE_ROLE_KEY` настроены

### Задача не запускается
- Проверьте timezone (должен быть Europe/Kiev)
- Убедитесь, что задача активна (не на паузе)
